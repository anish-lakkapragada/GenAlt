const e=["https://www.facebook.com","https://www.etsy.com"],n=["No photo description available.","Image","Logo"];function t(e){if(null==e)return!1;if(e.length<15||n.includes(e))return!1;return["h1","h2"].forEach((n=>{document.querySelectorAll(n).forEach((n=>{if(n.textContent==e)return!1}))})),!0}const l="Generating Caption By GenAlt",o=function(n){const t=n.origin;return!!e.includes(t)||!!n.href.includes("search?q=images")}(window.location);let s={},c={},a={},r=0;const i={};let u=chrome.runtime.connect({name:"background"});function g(e){const n=document.querySelectorAll("img");for(let t=0;t<n.length;t++){const o=n[t];if(null!=a[o.src]){if(e){o.alt=l;continue}o.alt=a[o.src]}}}u.onMessage.addListener((e=>{const{url:n,caption:t}=e,l=i[n];let o=!1;for(const e of l)null!==t?"ERROR"!==t?(o=!0,s[e.src]=t,e.alt=t,e.title=t,console.log(`setting the alt to : ${t}`)):(c[e.src]=!0,e.alt=a[e.src]):(c[e.src]=!0,e.alt=a[e.src]||"");o&&r++}));let d=null,m=null,f=null;async function p(){await new Promise((e=>{try{chrome.runtime.sendMessage({purpose:"runtimeId"},(n=>{if(null==n.runtimeId)return console.log(n),console.log("leaving"),void e();e()}))}catch(e){console.log(e),e.message.includes("Extension context invalidated")&&window.location.reload()}})),null==f&&(f=document.cloneNode(!0)),await new Promise((e=>{chrome.runtime.sendMessage({purpose:"params"},(n=>{console.log("this is current image alts"),console.log(s),s=Object.assign(s,n.IMAGE_ALTS),a=Object.assign(a,n.ORIGINAL_ALTS),c=Object.assign(c,n.ERROR_SRCS),d!=n.enabled&&null!=d&&g(),m!=n.language&&null!=m&&(s={},r=0,g(!0)),n.enabled&&(console.log("fixing it up!"),function(){let e=document.querySelectorAll("img");for(let n=0;n<e.length;n++){const r=e[n];null==c[r.src]&&(t(r.alt)||null!=s[r.src]?o&&null==s[r.src]?r.alt=l:t(r.alt)&&(r.title=r.alt):(console.log(t(r.alt)),console.log("this src useless: "+r.src),r.alt=l),a[r.src]=r.alt)}}(),function(e){for(const n of document.querySelectorAll("img"))r>=300?(n.alt=a[n.src],console.log(`exceeded limit: ${Object.keys(s).length}`)):n.alt==l&&null==s[n.src]?(console.log(`running again on: ${n.src}`),null==i[n.src]&&(i[n.src]=[n]),u.postMessage({url:n.src,language:e.language})):null!=s[n.src]&&s[n.src]!=n.alt&&(n.alt=s[n.src])}({maxCandidates:1,language:n.language})),m=n.language,d=n.enabled,e()}))}))}async function h(e){await new Promise((n=>{chrome.runtime.sendMessage({purpose:"params"},(t=>{t.IMAGE_ALTS!=s?(chrome.runtime.sendMessage({purpose:"update",needUpdate:"IMAGE_ALTS",IMAGE_ALTS:s}),e&&(s=t.IMAGE_ALTS)):t.ORIGINAL_ALTS!=a?(chrome.runtime.sendMessage({purpose:"update",needUpdate:"ORIGINAL_ALTS",ORIGINAL_ALTS:a}),e&&(a=t.ORIGINAL_ALTS)):t.ERROR_SRCS!=c&&(chrome.runtime.sendMessage({purpose:"update",needUpdate:"ERROR_SRCS",ERROR_SRCS:c}),e&&(c=t.ERROR_SRCS)),n()}))}))}function R(){for(const e of document.querySelectorAll("img"))null!=i[e.src]?i[e.src].push(e):i[e.src]=[e]}async function w(e){const n=new Image;n.src=e.src;let t=!0;return await new Promise((e=>{n.onload=()=>{(n.width<75||n.height<75)&&(t=!1),e()}})),t}window.addEventListener("load",(async()=>{R(),async function(){for(const e of document.querySelectorAll("img"))a[e.src]=e.alt,await w(e)||(c[e.src]=!0)}(),await new Promise((e=>{setTimeout(e,300)})),await h(!0),await p()})),setInterval(p,1500),setInterval(R,1500),setInterval((()=>{h(!1)}),18e4);

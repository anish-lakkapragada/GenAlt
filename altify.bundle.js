const e=["https://www.facebook.com","https://www.etsy.com"],n=["No photo description available.","Image","Logo"];function t(e){if(null==e)return!1;if(e.length<15||n.includes(e))return!1;return["h1","h2"].forEach((n=>{document.querySelectorAll(n).forEach((n=>{if(n.textContent==e)return!1}))})),!0}const s="Generating Caption By GenAlt",l=function(n){const t=n.origin;return!!e.includes(t)||!!n.href.includes("search?q=images")}(window.location);let o={},r={},c={};const a=[];let i=0;const u={};let d=chrome.runtime.connect({name:"background"});function g(e){const n=document.querySelectorAll("img");for(let t=0;t<n.length;t++){const l=n[t];if(null!=c[l.src]){if(e){l.alt=s;continue}l.alt=c[l.src]}}}d.onMessage.addListener((e=>{let{url:n,caption:t}=e;const s=u[n];console.log(`for this src: ${s[0].src}, you get this caption: ${t}`);for(const e of s)null!==t?"ERROR"!==t?(Math.random()<.35&&(t+=". Caption generated by GenAlt."),o[e.src]=t,e.alt=t,e.title=t):(console.warn(`this url: ${e.src} gives an error`),r[e.src]=!0,e.alt=c[e.src]||"",console.log(c[e.src])):(r[e.src]=!0,e.alt=c[e.src]||"")}));let m=null,f=null,h=null;async function p(){await new Promise((e=>{try{chrome.runtime.sendMessage({purpose:"runtimeId"},(n=>{if(null==n.runtimeId)return console.log(n),void e();e()}))}catch(e){console.log(e),e.message.includes("Extension context invalidated")&&window.location.reload()}})),null==h&&(h=document.cloneNode(!0)),await new Promise((e=>{chrome.runtime.sendMessage({purpose:"params"},(n=>{o=Object.assign(o,n.IMAGE_ALTS),c=Object.assign(c,n.ORIGINAL_ALTS),r=Object.assign(r,n.ERROR_SRCS),m!=n.enabled&&null!=m&&g(),f!=n.language&&null!=f&&(o={},i=0,g(!0)),n.enabled&&(function(){let e=document.querySelectorAll("img");for(let n=0;n<e.length;n++){const a=e[n];c[a.src]=a.alt,null==r[a.src]&&(t(a.alt)||null!=o[a.src]?l&&null==o[a.src]?a.alt=s:t(a.alt)&&(a.title=a.alt):a.alt=s)}}(),function(e){for(const n of document.querySelectorAll("img"))if(i>=100)console.log("MAX DONE STAHPPPPPP"),n.alt=c[n.src],g();else if(!(n.src.includes("data:image")||n.src.includes("svg")||n.src.includes("gif")))if(n.alt==s&&null==o[n.src]&&null==r[n.src]){if(a.includes(n.src))continue;null==u[n.src]&&(u[n.src]=[n]),n.width>=75&&n.height>=75&&(i++,console.log("trying this src: "+n.src),d.postMessage({url:n.src,language:e.language})),a.push(n.src)}else null!=o[n.src]&&o[n.src]!=n.alt&&(n.alt=o[n.src])}({maxCandidates:1,language:n.language})),f=n.language,m=n.enabled,e()}))}))}async function A(e){await new Promise((n=>{chrome.runtime.sendMessage({purpose:"params"},(t=>{t.IMAGE_ALTS!=o?(chrome.runtime.sendMessage({purpose:"update",needUpdate:"IMAGE_ALTS",IMAGE_ALTS:o}),e&&(o=t.IMAGE_ALTS)):t.ORIGINAL_ALTS!=c?(chrome.runtime.sendMessage({purpose:"update",needUpdate:"ORIGINAL_ALTS",ORIGINAL_ALTS:c}),e&&(c=t.ORIGINAL_ALTS)):t.ERROR_SRCS!=r&&(chrome.runtime.sendMessage({purpose:"update",needUpdate:"ERROR_SRCS",ERROR_SRCS:r}),e&&(r=t.ERROR_SRCS)),n()}))}))}function w(){for(const e of document.querySelectorAll("img"))null!=u[e.src]?u[e.src].push(e):u[e.src]=[e]}async function R(e){const n=new Image;n.src=e.src;let t=!0;return await new Promise((e=>{n.onload=()=>{(n.width<75||n.height<75)&&(t=!1),e()}})),t}window.addEventListener("load",(async()=>{w(),async function(){for(const e of document.querySelectorAll("img"))c[e.src]=e.alt,await R(e)||(r[e.src]=!0)}(),await new Promise((e=>{setTimeout(e,300)})),await A(!0),await p()})),setInterval(p,1500),setInterval(w,1500),setInterval((()=>{console.log(`num tries: ${i} and max tries: 100`)}),2e3),setInterval((()=>{A(!1)}),18e4);

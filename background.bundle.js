"use strict";console.log("here yay!");const e={numCalls:0,date:new Date};chrome.runtime.onConnect.addListener((t=>{const a=t;console.log(`the name for this port is: ${a.name}`),a.onMessage.addListener((async t=>{const{url:o,language:n}=t;console.log(`using this language: ${n}`),6==e.numCalls&&(console.log("waiting"),await new Promise((t=>setTimeout(t,1e3-(new Date-e.date)))),console.log("done waiting"),e.numCalls=0,e.date=new Date);const s=await async function(e,t){const a="https://poggers-image-captioning-api.cognitiveservices.azure.com/vision/v3.2/describe?maxCandidates=1&language="+t.language,o=await fetch(a,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json","Ocp-Apim-Subscription-Key":"78e4e95e416348b6b841a36cd2f7ac50"},body:JSON.stringify({url:e})}),n=await o.json();return null==n.description||0==n?.description.captions.length?"ERROR":n.description.captions[0].text}(o,{maxCandidates:1,language:n});if(e.numCalls++,"ERROR"!==s){if(function(e){if(null==e)return!1;const t=["Text".toUpperCase(),"Image".toUpperCase(),"Letter".toUpperCase(),"Application".toUpperCase(),"Logo".toUpperCase(),"Diagram".toUpperCase(),"chart".toUpperCase(),"graph".toUpperCase(),"graphical user interface, website".toUpperCase(),"graphical user interface, text, application".toUpperCase(),"graphical user interface".toUpperCase()],a=e.toUpperCase();if(t.includes(a))return!0;for(const e of t)if(e.includes(a))return!0;return!1}(s)){const t=await async function(e){let t="OCR Description: ";const a=(await fetch("https://poggers-image-captioning-api.cognitiveservices.azure.com/vision/v3.2/read/analyze",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json","Ocp-Apim-Subscription-Key":"78e4e95e416348b6b841a36cd2f7ac50"},body:JSON.stringify({url:e})})).headers.get("Operation-Location");setTimeout((()=>{}),750);const o=setInterval((()=>{fetch(a,{headers:{"Ocp-Apim-Subscription-Key":"78e4e95e416348b6b841a36cd2f7ac50"}}).then((e=>e.json())).then((e=>{if(console.log(e.status),"succeeded"===e.status){for(const a of e.analyzeResult.readResults[0].lines){let e="";for(const t of a.words)e+=t.text+" ";t+=e+"\n"}console.log(t),clearInterval(o)}}))}),1e3);return t}(o),n=t.length>s.length?t:s;return e.numCalls++,void a.postMessage({url:o,caption:n})}a.postMessage({url:o,caption:s})}else a.postMessage({url:o,caption:s})}))})),chrome.runtime.onInstalled.addListener((e=>{console.log(`runtime id: ${chrome.runtime.id}`),"install"==e.reason&&chrome.tabs.create({url:chrome.runtime.getURL("usage.html")}),chrome.storage.local.set({enabled:!0,language:"en"});for(const e of["IMAGE_ALTS","ERROR_SRCS","ORIGINAL_ALTS"]){const t={};t[e]={},chrome.storage.local.set(t)}})),chrome.runtime.onMessage.addListener(((e,t,a)=>{if("params"===e.purpose)chrome.storage.local.get(["enabled","language","IMAGE_ALTS","ERROR_SRCS","ORIGINAL_ALTS"],(e=>{console.log("this lang from background script: "+e.language),a(e)}));else if("update"===e.purpose){const{needUpdate:t}=e;try{chrome.storage.local.set({needUpdate:e[t]})}catch(e){console.log("error with background storage : "+e)}}else"runtimeId"===e.purpose&&a({runtimeId:chrome.runtime.id});return!0}));
